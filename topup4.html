<!DOCTYPE html>
<html>
<head>
  <title>Top Up Form (Offline)</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 400px;
      margin: auto;
    }
    input, button {
      margin: 5px 0;
      width: 100%;
      padding: 10px;
      font-size: 16px;
    }
    input, button {
      box-sizing: border-box;
    }
    input[type="radio"] {
      width: auto;
    }
    #scanner {
      width: 100%;
      margin-top: 10px;
    }
    #result {
      margin-top: 20px;
      text-align: center;
      font-size: 48px;
      font-weight: bold;
      padding: 20px;
      border-radius: 10px;
    }
    #waitMessage {
      text-align: center;
      font-weight: bold;
      color: #555;
      margin-top: 10px;
    }
    #continueBtn, #downloadBtn {
      display: none;
      margin-top: 10px;
      padding: 10px;
      font-size: 16px;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #scanSection {
      display: none;
    }
    #logList {
      margin-top: 20px;
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      font-size: 14px;
    }
    #logEntries {
      list-style: none;
      padding-left: 0;
    }
    #logEntries li {
      margin-bottom: 10px;
      border-bottom: 1px dashed #aaa;
      padding-bottom: 5px;
    }
  </style>
</head>
<body>
  <!-- Front Page -->
  <div id="frontPage">
    <h2>Masukkan Operator ID</h2>
    <div style="font-size: 12px; color: #888; margin-bottom: 10px;">ver 4.1</div>
    <input type="text" id="operatorId" placeholder="Enter your ID">
    <button id="continueBtnMain">→ Continue</button>
  </div>

  <!-- Scan Section -->
  <div id="scanSection">
    <h2>TOP UP SCAN FORM</h2>

    <div id="scanner"></div>

    <label>Scan Assy Barcode:</label>
    <input type="text" id="assyBarcode" readonly>
    <button onclick="startScan('assy')">Scan Assy</button>

    <label>Scan Top Up Barcode:</label>
    <input type="text" id="topupBarcode" readonly>
    <button onclick="startScan('topup')">Scan Top Up</button>

    <label>Top Up Qty:</label>
    <input type="number" id="qty">

    <button onclick="goToAddBatch()">Add Top Up Batch</button>

    <label>TOP UP REASON:</label>
    <div style="margin: 5px 0;">
      <label style="display: flex; align-items: center; gap: 8px;">
        <input type="radio" name="reason" value="Due to Reject" checked>
        Due to Reject
      </label>
      <label style="display: flex; align-items: center; gap: 8px;">
        <input type="radio" name="reason" value="Due to Less Qty">
        Due to Less Qty
      </label>
    </div>

    <button onclick="submitForm()">Submit</button>
    <button onclick="stopScan()">Stop Scan</button>

    <div id="waitMessage"></div>
    <div id="result"></div>
    <button id="continueBtn" onclick="resetForm()">Continue</button>
    <button id="downloadBtn" onclick="downloadCSV()">Download CSV Log</button>

    <div id="logList">
      <strong>Log Preview:</strong>
      <ul id="logEntries"></ul>
    </div>
  </div>

<div id="addBatchPage" style="display: none;">
  <h2>ADD TOP UP BATCH</h2>
  <div id="scannerAddBatch" style="margin-top: 10px;"></div>
  
  <label>Scan Top Up Barcode:</label>
  <input type="text" id="newTopupBarcode" readonly>
  <button onclick="startScan('newTopup')">Scan Top Up</button>

  <label>Initial Qty:</label>
  <input type="number" id="initialQty">

  <button onclick="saveTopupBatch()">Save Batch</button>
  <button onclick="goBackToMain()">← Back</button>

  <div id="batchMessage" style="margin-top: 10px; font-weight: bold;"></div>
</div>


  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    let currentTarget = "";
    let scannerInstance = null;
    let operatorIdGlobal = "";

    document.getElementById("continueBtnMain").addEventListener("click", () => {
      const id = document.getElementById("operatorId").value.trim();
      if (!id) {
        alert("Masukkan Operator ID terlebih dahulu.");
        return;
      }
      operatorIdGlobal = id;
      document.getElementById("frontPage").style.display = "none";
      document.getElementById("scanSection").style.display = "block";
    });

    async function startScan(target) {
  currentTarget = target;

  // Tentukan div scanner yang dipakai
  const scannerDivId = target === "newTopup" ? "scannerAddBatch" : "scanner";
  const scannerDiv = document.getElementById(scannerDivId);
  scannerDiv.innerHTML = "";

  // Stop scanner sebelumnya
  if (scannerInstance) {
    try {
      await scannerInstance.stop();
      await scannerInstance.clear();
    } catch (err) {
      console.warn("Stop/clear error:", err);
    }
  }

  scannerInstance = new Html5Qrcode(scannerDivId);

  scannerInstance.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    qrCodeMessage => {
      const cleanMessage = qrCodeMessage.replace(/[^\x20-\x7E]/g, '').trim();
      document.getElementById(target + "Barcode").value = cleanMessage;

      scannerInstance.stop().then(() => scannerInstance.clear());
      scannerDiv.innerHTML = "";
    }
  ).catch(err => {
    console.warn("Gagal akses kamera:", err);
  });
}

    function stopScan() {
      if (scannerInstance) {
        scannerInstance.stop().then(() => {
          document.getElementById("scanner").innerHTML = "";
        }).catch(err => {
          console.warn("Gagal stop scanner:", err);
        });
      }
    }

function submitForm() {
  const assy = document.getElementById("assyBarcode").value;
  const topup = document.getElementById("topupBarcode").value;
  const qty = document.getElementById("qty").value;
  const reason = document.querySelector('input[name="reason"]:checked').value;

  document.getElementById("waitMessage").innerText = "Please wait .. system is processing the data";
  document.getElementById("result").innerText = "";
  document.getElementById("continueBtn").style.display = "none";

  try {
    const assyParts = assy.split(",");
    const topupParts = topup.split(",");

    if (assyParts.length < 20 || topupParts.length < 20) {
      throw new Error("Format QR code tidak valid");
    }

    const judgement = (assyParts[1] === topupParts[1]) &&
                      (assyParts[19] === topupParts[19]) ? "OK" : "NG";

    const timestamp = new Date().toLocaleString();

    // Ambil saldo batch
    let batchList = JSON.parse(localStorage.getItem("topupBatchList") || "[]");
    const topupPart = topupParts[1];
    const topupBatch = topupParts[2];
    const topupQty = parseInt(qty);

    const batchData = batchList.find(b =>
      b.partNumber === topupPart && b.batchNumber === topupBatch
    );

    if (!batchData) {
      throw new Error("Batch belum terdaftar. Tambahkan dulu di 'Add Top Up Batch'.");
    }

    const balance = batchData.initialQty - batchData.usedQty;
    if (topupQty > balance) {
      throw new Error(`Balance tidak cukup, tersisa tinggal ${balance}`);
    }

    // Update usedQty
    if (judgement === "OK") {
      batchData.usedQty += topupQty;
      localStorage.setItem("topupBatchList", JSON.stringify(batchList));
    }



    const reelAssy = assyParts[18];
    const reelTopup = topupParts[18];
    const balanceAfter = judgement === "OK"
      ? batchData.initialQty - batchData.usedQty
      : batchData.initialQty;


    const newRow = [
      timestamp,
      assyParts[1], assyParts[19], assyParts[2], reelAssy,
      topupParts[1], topupParts[19], topupParts[2], reelTopup,
      qty, reason, judgement, operatorIdGlobal,
      balanceAfter
    ];

    let logData = JSON.parse(localStorage.getItem("topupLog") || "[]");
    logData.push(newRow);
    localStorage.setItem("topupLog", JSON.stringify(logData));

    showJudgement(judgement);
    document.getElementById("downloadBtn").style.display = "inline-block";
    appendLogEntry(newRow);

  } catch (err) {
    document.getElementById("waitMessage").innerText = "";
    document.getElementById("result").innerText = "Gagal submit: " + err.message;
  }
}

    function showJudgement(judgement) {
      document.getElementById("waitMessage").innerText = "";
      const resultDiv = document.getElementById("result");
      resultDiv.innerText = judgement;
      resultDiv.style.backgroundColor = judgement === "OK" ? "#4CAF50" : "#F44336";
      resultDiv.style.color = judgement === "OK" ? "#000" : "#FFF";
      document.getElementById("continueBtn").style.display = "inline-block";
    }

    function resetForm() {
      document.getElementById("assyBarcode").value = "";
      document.getElementById("topupBarcode").value = "";
      document.getElementById("qty").value = "";
      document.getElementById("result").innerText = "";
      document.getElementById("result").style.backgroundColor = "";
      document.getElementById("waitMessage").innerText = "";
      document.getElementById("continueBtn").style.display = "none";
    }

function appendLogEntry(row) {
  const entryHTML = `
    <li>
      <div><strong>${row[0]}</strong></div>
      <div>Assy: ${row[1]} - ${row[2]} | Batch: ${row[3]} | Reel: ${row[4]}</div>
      <div>Top Up: ${row[5]} - ${row[6]} | Batch: ${row[7]} | Reel: ${row[8]}</div>
      <div>Qty: ${row[9]} | Reason: ${row[10]} | Judgement: ${row[11]} | Operator: ${row[12]}</div>
      <div>Balance After Top Up: ${row[13]}</div>
    </li>
  `;
  document.getElementById("logEntries").insertAdjacentHTML("afterbegin", entryHTML);
}

function goToAddBatch() {
  document.getElementById("scanSection").style.display = "none";
  document.getElementById("addBatchPage").style.display = "block";
}

function goBackToMain() {
  document.getElementById("addBatchPage").style.display = "none";
  document.getElementById("scanSection").style.display = "block";
}

function saveTopupBatch() {
  const raw = document.getElementById("newTopupBarcode").value.trim();
  const qty = parseInt(document.getElementById("initialQty").value.trim());
  const msgDiv = document.getElementById("batchMessage");

  if (!raw || isNaN(qty) || qty <= 0) {
    msgDiv.innerText = "Scan barcode dan masukkan qty yang valid.";
    msgDiv.style.color = "red";
    return;
  }

  const parts = raw.split(",");
  if (parts.length < 20) {
    msgDiv.innerText = "Format QR tidak valid.";
    msgDiv.style.color = "red";
    return;
  }

  const partNumber = parts[1];
  const batchNumber = parts[2];

  let batchList = JSON.parse(localStorage.getItem("topupBatchList") || "[]");

  const existing = batchList.find(b =>
    b.partNumber === partNumber && b.batchNumber === batchNumber
  );

  if (existing) {
    msgDiv.innerText = "Batch ini sudah pernah ditambahkan.";
    msgDiv.style.color = "orange";
    return;
  }

  batchList.push({
    partNumber,
    batchNumber,
    initialQty: qty,
    usedQty: 0
  });

  localStorage.setItem("topupBatchList", JSON.stringify(batchList));

  msgDiv.innerText = "Batch berhasil disimpan.";
  msgDiv.style.color = "green";

  // Reset input
  document.getElementById("newTopupBarcode").value = "";
  document.getElementById("initialQty").value = "";
}


function downloadCSV() {
  let logData = JSON.parse(localStorage.getItem("topupLog") || "[]");
  let csv = "Timestamp,Assy Part Number,Assy Part Name,Assy Batch Number,Assy Reel,Top Up Part Number,Top Up Part Name,Top Up Batch Number,Top Up Reel,Qty,Reason,Judgement,Operator ID,Balance After Top Up\n";
  logData.forEach(row => {
    csv += row.map(item => `"${item}"`).join(",") + "\n";
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "topup_log.csv";
  link.click();
}
  </script>
</body>
</html>
















